{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Profile</title>
    <link rel="icon" type="image/png" href="{% static 'images/smiley.png' %}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'css/profile_update.css' %}" />
    <style>
      .alert {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1050;
        max-width: 300px;
        width: 16rem;
        height: 55px;
        margin: 0;
        opacity: 0;
        animation: fadeIn 2s forwards;
        background-color: #28a745;
        color: white;
      }

      @keyframes fadeIn {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .hide-alert {
        display: none !important;
      }

      .update-btn {
        position: relative;
        top: -7.8rem;
        right: -9.3rem;
        width: 70%;
        height: 50px;
        padding: 10px 30px;
        background-color: #28a745;
        color: white;
        text-align: center;
        border: 2px solid white;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
        overflow: hidden;
        z-index: 1;
        transition: color 0.3s ease;
      }

      #edit-btn {
        position: relative;
        top: 8rem;
        left: -21.2rem;
        width: auto;
        padding: 10px 30px;
        background-color: white;
        border: none;
        color: #28a745;
        text-align: center;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      #edit-btn img {
        width: 15px;
        aspect-ratio: 1;
      }

      #edit-btn:hover {
        transform: scale(1.1);
        transition: color 0.3s ease;
      }

      footer {
        position: relative;
        left: 0;
        right: 0;
        height: auto;
        width: 100%;
        display: flex;
        position: relative;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        padding-top: 40px;
        color: #fff;
        background-color: #111111;
      }

      @media (min-width: 501px) and (max-width: 768px) {
        .navbar-toggler {
          background-color: #28a745;
        }

        .profile-image {
          position: relative;
          top: 8px;
          left: -20rem;
          border-radius: 50%;
          object-fit: cover;
          margin-bottom: 10px;
          border: 2px solid #28a745;
        }

        #edit-btn {
          top: 7rem;
          left: -13.2rem;
          border: none;
          padding: 5px;
        }

        #edit-btn img {
          width: 20px;
          aspect-ratio: 1;
        }

        #edit-btn:hover {
          transform: scale(1.1);
          transition: color 0.3s ease;
          background-color: transparent;
          color: #28a745;
        }

        .update-btn {
          width: 73%;
          /* top: 20px; */
          right: -78px;
        }
      }

      @media (max-width: 500px) {
        .footer-menu ul {
          display: flex;
          margin-top: 10px;
          margin-bottom: 20px;
        }

        body,
        html {
          height: auto;
        }

        .navbar-brand {
          font-size: 22px;
        }

        .footer-content p {
          padding: 12px;
        }

        .footer-bottom p {
          font-size: 10px;
          color: #aaa;
        }

        .container {
          padding: 10px;
          margin-bottom: 80px;
          height: auto;
        }

        .navbar-toggler {
          background-color: #28a745;
        }

        .profile-form {
          width: 90%;
          margin-left: 0;
          padding: 1px;
        }

        .profile-image {
          position: relative;
          top: 8px;
          left: -8rem;
          border-radius: 50%;
          width: 100px;
          height: 100px;
          object-fit: cover;
          margin-bottom: 10px;
          border: 2px solid #28a745;
        }

        #edit-btn {
          top: 10px;
          left: 4rem;
          border: none;
          padding: 5px;
        }

        #edit-btn img {
          width: 20px;
          aspect-ratio: 1;
        }

        #edit-btn:hover {
          transform: scale(1.1);
          transition: color 0.3s ease;
          background-color: transparent;
          color: #28a745;
        }

        .form-group label {
          width: 100%;
          margin-bottom: 10px;
          font-size: 14px;
        }

        .form-group .form-control {
          width: 100%;
          padding: 10px;
          margin-bottom: 10px;
        }

        .update-btn {
          width: 100%;
          top: 20px;
          right: 0;
        }

        .form-group {
          width: 100%;
          margin-bottom: 20px;
          display: block;
          top: 1rem;
        }

        footer {
          position: relative;
          padding-top: 20px;
          bottom: 0;
        }
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-light"
      id="navbar"
      style="transition: background-color 0.3s ease-in-out"
    >
      <a class="navbar-brand" href="{% url 'index' %}">Tomato Guard</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <!-- Home, Services, About Links -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'index' %}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'about' %}">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'services' %}">Services</a>
          </li>

          {% if user.is_authenticated %}
          <!-- User Profile Image and Dropdown -->
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="navbarDropdown"
              role="button"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
              <!-- <img
                src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}{% static 'default_profile.jpg' %}{% endif %}"
                class="rounded-circle"
                width="30"
                height="30"
                alt=""
              /> -->
              <img
                src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}https://res.cloudinary.com/dwuhvmvoh/image/upload/v1737505143/t-smiley_salgk5.png{% endif %}"
                class="rounded-circle"
                width="30"
                height="30"
                alt=""
              />
            </a>
            <ul
              class="dropdown-menu dropdown-menu-end mt-4"
              aria-labelledby="navbarDropdown"
            >
              <!-- User's Name and Email -->
              <div
                class="dropdown-item text-center"
                style="pointer-events: none"
              >
                <strong>{{ user.get_full_name }}</strong><br />
                <small>{{ user.email }}</small>
              </div>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="{% url 'profile_update' %}"
                  >Update Profile</a
                >
              </li>
              <li>
                <a class="dropdown-item" href="{% url 'uploaded_images' %}"
                  >My Uploads</a
                >
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
              </li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item">
            <a
              class="nav-link"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#loginModal"
              >Login</a
            >
          </li>
          {% endif %}
        </ul>
      </div>
    </nav>

    {% if messages %}
    <div id="successMessage" class="alert" role="alert">
      {% for message in messages %}
      <p>{{ message }}</p>
      {% endfor %}
    </div>
    {% endif %}

    <div class="container">
      <!-- Profile Form Section -->
      <div class="profile-form">
        <h2>My Profile</h2>
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- Profile Image Section inside the form -->
          <div class="profile-section">
            <!-- Hidden File Input -->
            <input
              type="file"
              class="form-control-file"
              id="profile_image"
              name="image"
              accept="image/*"
              onchange="previewImage(event)"
              style="display: none"
            />
            <!-- Label to trigger file input -->
            <label for="profile_image" class="edit-image-btn" id="edit-btn">
              <img src="{% static 'images/edit.png' %}" alt="" /> Edit
            </label>
            <!-- Profile Image that will show the preview -->
            <img
              id="profilePreview"
              src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}https://res.cloudinary.com/dwuhvmvoh/image/upload/v1737505143/t-smiley_salgk5.png{% endif %}"
              alt="Profile Image"
              class="profile-image"
            />
          </div>

          <!-- Username -->
          <div class="form-group">
            <label for="username" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="username"
              name="username"
              value="{{ user.username }}"
            />
          </div>

          <!-- First Name -->
          <div class="form-group">
            <label for="first_name" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control"
              id="first_name"
              name="first_name"
              value="{{ user.first_name }}"
            />
          </div>

          <!-- Last Name -->
          <div class="form-group">
            <label for="last_name" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="last_name"
              name="last_name"
              value="{{ user.last_name }}"
            />
          </div>

          <!-- Email -->
          <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              value="{{ user.email }}"
            />
          </div>

          <!-- Update Button -->
          <button type="submit" class="update-btn">Update Profile</button>
        </form>
      </div>
    </div>

    <footer>
      <div class="footer-content">
        <h3>Tomato Guard</h3>
      </div>
      <div class="footer-bottom">
        <p>copyright &copy; 2025 Tomato Disease Detection</p>
        <div class="footer-menu"></div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function previewImage(event) {
        // Get the file from the input
        const file = event.target.files[0];

        // Check if a file is selected
        if (file) {
          // Create a new URL for the selected image
          const reader = new FileReader();

          // Set up the function to run when the file is read
          reader.onload = function (e) {
            // Set the image preview to the result from FileReader
            const preview = document.getElementById("profilePreview");
            preview.src = e.target.result; // This will update the <img> with the preview
          };

          // Read the image file as a data URL
          reader.readAsDataURL(file);
        }
      }

      // Hide the success message after 5 seconds
      window.addEventListener("DOMContentLoaded", function () {
        const successMessage = document.getElementById("successMessage");
        if (successMessage) {
          setTimeout(function () {
            successMessage.classList.add("hide-alert");
          }, 5000); // Hide after 5 seconds
        }
      });
    </script>
  </body>
</html>
